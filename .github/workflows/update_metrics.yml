name: Update PowerBI Metrics

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/5 * * * *"

concurrency:
  group: update-powerbi-metrics
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # CHECKOUT REPOSITORY
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------------------------------------
      # INSTALL DEPENDENCIES
      # ------------------------------------------------------------
      - name: Install dependencies
        run: npm install puppeteer

      # ------------------------------------------------------------
      # DETERMINE WHETHER THIS RUN SHOULD SCRAPE (DST-SAFE)
      # ------------------------------------------------------------
      - name: Determine local AU time
        id: timecheck
        run: |
          NOW_UTC=$(date -u '+%Y-%m-%d %H:%M')
          NOW_LOCAL=$(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M')
          DAY_OF_WEEK=$(TZ=Australia/Sydney date '+%u')

          echo "UTC time:    $NOW_UTC"
          echo "Local time:  $NOW_LOCAL"
          echo "Day of week: $DAY_OF_WEEK"
          echo "Event:       $GITHUB_EVENT_NAME"

          SHOULD_RUN=false

          # Monday–Thursday (1–4): run at 17:00
          if [ "$DAY_OF_WEEK" -ge 1 ] && [ "$DAY_OF_WEEK" -le 4 ] && [[ "$NOW_LOCAL" == *"17:00" ]]; then
            SHOULD_RUN=true
          fi

          # Friday (5): run at 12:00, 14:00, 15:00, 16:00, 17:00
          if [ "$DAY_OF_WEEK" = "5" ]; then
            case "$NOW_LOCAL" in
              *"12:00"|*"14:00"|*"15:00"|*"16:00"|*"17:00")
                SHOULD_RUN=true
                ;;
            esac
          fi

          # Manual run override
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            echo "Manual run detected – forcing scrape"
            SHOULD_RUN=true
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # RUN SCRAPER (ONLY IF TIME MATCHES OR MANUAL RUN)
      # ------------------------------------------------------------
      - name: Run scraper
        if: steps.timecheck.outputs.should_run == 'true'
        run: node scripts/scrape_metrics.js

      # ------------------------------------------------------------
      # COMMIT CHANGES ONLY IF FILE HAS CHANGED
      # ------------------------------------------------------------
      - name: Commit and push metrics.json
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          if git diff --quiet metrics.json; then
            echo "No changes detected; skipping commit"
            exit 0
          fi

          git add metrics.json
          git commit -m "Update Power BI metrics"
          git push

      # ------------------------------------------------------------
      # ALERT ON FAILURE
      # ------------------------------------------------------------
      - name: Alert on failure
        if: failure()
        run: |
          echo "❌ Power BI scrape failed" >&2
