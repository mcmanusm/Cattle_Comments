name: Update PowerBI Metrics

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/5 * * * *"

concurrency:
  group: update-powerbi-metrics
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # CHECKOUT REPOSITORY
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------------------------------------
      # INSTALL DEPENDENCIES
      # ------------------------------------------------------------
      - name: Install dependencies
        run: npm install puppeteer

      # ------------------------------------------------------------
      # DETERMINE WHETHER THIS RUN SHOULD SCRAPE (EXACT TIME MATCH)
      # ------------------------------------------------------------
      - name: Determine local AU time
        id: timecheck
        run: |
          DAY_OF_WEEK=$(TZ=Australia/Sydney date '+%u')
          HOUR=$(TZ=Australia/Sydney date '+%H')
          MINUTE=$(TZ=Australia/Sydney date '+%M')

          echo "Day of week: $DAY_OF_WEEK"
          echo "Hour:        $HOUR"
          echo "Minute:      $MINUTE"
          echo "Event:       $GITHUB_EVENT_NAME"

          SHOULD_RUN=false

          # --------------------------------------------------------
          # TEMPORARY TEST WINDOW (21:10–21:15 Sydney)
          # --------------------------------------------------------
          if [ "$HOUR" = "21" -a "$MINUTE" -ge 10 -a "$MINUTE" -le 15 ]; then
            echo "TEST WINDOW MATCHED (21:10–21:15 Sydney)"
            SHOULD_RUN=true
          fi



          
          # --------------------------------------------------------
          # Mon–Thu (1–4) at exactly 17:00
          # --------------------------------------------------------
          if [ "$DAY_OF_WEEK" -ge 1 ] && [ "$DAY_OF_WEEK" -le 4 ] \
             && [ "$HOUR" = "17" ] && [ "$MINUTE" = "00" ]; then
            SHOULD_RUN=true
          fi

          # --------------------------------------------------------
          # Friday (5) at exactly 12,14,15,16,17
          # --------------------------------------------------------
          if [ "$DAY_OF_WEEK" = "5" ] && [ "$MINUTE" = "00" ]; then
            case "$HOUR" in
              12|14|15|16|17)
                SHOULD_RUN=true
                ;;
            esac
          fi

          # --------------------------------------------------------
          # Manual override
          # --------------------------------------------------------
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            echo "Manual run detected – forcing scrape"
            SHOULD_RUN=true
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # RUN SCRAPER
      # ------------------------------------------------------------
      - name: Run scraper
        if: steps.timecheck.outputs.should_run == 'true'
        run: node scripts/scrape_metrics.js

      # ------------------------------------------------------------
      # COMMIT CHANGES (ONLY IF FILE CHANGED)
      # ------------------------------------------------------------
      - name: Commit and push metrics.json
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          if git diff --quiet metrics.json; then
            echo "No changes detected; skipping commit"
            exit 0
          fi

          git add metrics.json
          git commit -m "Update Power BI metrics"
          git push

      # ------------------------------------------------------------
      # FAIL LOUDLY IF SCRAPE FAILED
      # ------------------------------------------------------------
      - name: Alert on failure
        if: failure()
        run: |
          echo "❌ Power BI scrape failed" >&2
