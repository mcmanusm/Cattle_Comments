name: Update PowerBI Metrics

on:
  workflow_dispatch: {}
  schedule:
    # Run every 10 minutes for testing
    - cron: "*/10 * * * *"

concurrency:
  group: update-powerbi-metrics
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # CHECKOUT REPOSITORY
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------------------------------------
      # INSTALL DEPENDENCIES
      # ------------------------------------------------------------
      - name: Install dependencies
        run: |
          npm install puppeteer
          sudo apt-get install -y jq

      # ------------------------------------------------------------
      # CHECK IF SCRAPE IS NEEDED (runs every time)
      # ------------------------------------------------------------
      - name: Check current time
        id: timecheck
        run: |
          TODAY=$(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M:%S %Z')
          echo "Sydney time: $TODAY"
          echo "Running hourly scrape check..."
          echo "should_run=true" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # RUN SCRAPER
      # ------------------------------------------------------------
      - name: Run scraper
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          echo "Running scraper..."
          node scripts/scrape_metrics.js
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      # ------------------------------------------------------------
      # CHECK IF METRICS CHANGED
      # ------------------------------------------------------------
      - name: Check if metrics changed
        id: check_changes
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          # Create backup of old metrics if it exists
          if [ -f "metrics.json" ]; then
            cp metrics.json metrics.old.json
            echo "has_old_metrics=true" >> $GITHUB_OUTPUT
          else
            echo "has_old_metrics=false" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------------------------
      # UPDATE AUTOMATION STATE
      # ------------------------------------------------------------
      - name: Update automation state
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          SLOT="${{ steps.timecheck.outputs.slot }}"
          TODAY=$(TZ=Australia/Sydney date '+%Y-%m-%d')

          echo "Updating state: $SLOT -> $TODAY"
          
          # Create state file if it doesn't exist
          if [ ! -f "automation_state.json" ]; then
            echo '{"runs":{}}' > automation_state.json
          fi
          
          jq ".runs[\"$SLOT\"] = \"$TODAY\"" automation_state.json > tmp.json
          mv tmp.json automation_state.json
          
          echo "Updated state file:"
          cat automation_state.json

      # ------------------------------------------------------------
      # COMMIT CHANGES (only if metrics actually changed)
      # ------------------------------------------------------------
      - name: Commit and push changes
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          # Compare old and new metrics
          if [ -f "metrics.old.json" ]; then
            if cmp -s metrics.json metrics.old.json; then
              echo "✗ Metrics unchanged — skipping commit"
              rm metrics.old.json
              exit 0
            else
              echo "✓ Metrics changed — committing update"
              rm metrics.old.json
            fi
          else
            echo "✓ First run or no previous metrics — committing"
          fi

          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          git add metrics.json

          if git diff --cached --quiet; then
            echo "No changes detected; skipping commit"
            exit 0
          fi

          COMMIT_MSG="Update Power BI metrics [$(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')]"
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "✓ Successfully committed and pushed changes"

      # ------------------------------------------------------------
      # ALERT ON FAILURE
      # ------------------------------------------------------------
      - name: Alert on failure
        if: failure()
        run: |
          echo "❌ Power BI scrape failed" >&2
          echo "Check the logs above for details" >&2
          exit 1
