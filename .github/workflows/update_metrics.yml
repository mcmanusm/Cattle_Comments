name: Update PowerBI Metrics

on:
  workflow_dispatch: {}
  schedule:
    # Run every 10 minutes for testing
    - cron: "*/10 * * * *"

concurrency:
  group: update-powerbi-metrics
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # CHECKOUT REPOSITORY
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------------------------------------
      # INSTALL DEPENDENCIES
      # ------------------------------------------------------------
      - name: Install dependencies
        run: |
          npm install puppeteer
          sudo apt-get install -y jq

      # ------------------------------------------------------------
      # BACKUP OLD METRICS (before scraping)
      # ------------------------------------------------------------
      - name: Backup old metrics
        id: backup
        run: |
          if [ -f "metrics.json" ]; then
            cp metrics.json metrics.old.json
            echo "has_backup=true" >> $GITHUB_OUTPUT
            echo "✓ Backed up existing metrics.json"
          else
            echo "has_backup=false" >> $GITHUB_OUTPUT
            echo "ℹ No existing metrics.json to backup"
          fi

      # ------------------------------------------------------------
      # RUN SCRAPER
      # ------------------------------------------------------------
      - name: Run scraper
        run: |
          echo "Running scraper..."
          node scripts/scrape_metrics.js
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      # ------------------------------------------------------------
      # CHECK IF METRICS CHANGED
      # ------------------------------------------------------------
      - name: Check if metrics changed
        id: check_changes
        run: |
          if [ "${{ steps.backup.outputs.has_backup }}" = "true" ]; then
            if cmp -s metrics.json metrics.old.json; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "✗ Metrics unchanged"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "✓ Metrics changed"
            fi
            rm metrics.old.json
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ First run - will commit"
          fi

      # ------------------------------------------------------------
      # COMMIT CHANGES (only if metrics changed)
      # ------------------------------------------------------------
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          git add metrics.json

          if git diff --cached --quiet; then
            echo "✗ No changes to commit (shouldn't happen)"
            exit 0
          fi

          COMMIT_MSG="Update Power BI metrics [$(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')]"
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "✓ Successfully committed and pushed changes"

      # ------------------------------------------------------------
      # ALERT ON FAILURE
      # ------------------------------------------------------------
      - name: Alert on failure
        if: failure()
        run: |
          echo "❌ Power BI scrape failed" >&2
          echo "Check the logs above for details" >&2
          exit 1
