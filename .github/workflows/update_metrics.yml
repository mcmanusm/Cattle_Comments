name: Update PowerBI Metrics

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/5 * * * *"

concurrency:
  group: update-powerbi-metrics
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # CHECKOUT REPOSITORY
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ------------------------------------------------------------
      # INSTALL DEPENDENCIES
      # ------------------------------------------------------------
      - name: Install dependencies
        run: |
          npm install puppeteer
          sudo apt-get install -y jq

      # ------------------------------------------------------------
      # DETERMINE WHETHER THIS RUN SHOULD SCRAPE
      # ------------------------------------------------------------
      - name: Determine local AU time
        id: timecheck
        run: |
          STATE_FILE=".automation_state.json"
          TODAY=$(TZ=Australia/Sydney date '+%Y-%m-%d')
          DAY_OF_WEEK=$(TZ=Australia/Sydney date '+%u')
          HOUR=$(TZ=Australia/Sydney date '+%H')
          MINUTE=$(TZ=Australia/Sydney date '+%M')

          echo "Today: $TODAY"
          echo "Day of week: $DAY_OF_WEEK"
          echo "Hour: $HOUR"
          echo "Minute: $MINUTE"
          echo "Event: $GITHUB_EVENT_NAME"

          SHOULD_RUN=false
          SLOT=""

          # --------------------------------------------------------
          # ðŸ”´ TEMPORARY TEST OVERRIDE â€” RUN ONCE AFTER 21:25 SYDNEY
          # --------------------------------------------------------
          if [ "$HOUR" -ge 21 ] && [ "$MINUTE" -ge 25 ]; then
            SLOT="test_925"
          fi

          # --------------------------------------------------------
          # NORMAL PRODUCTION LOGIC (UNCHANGED)
          # --------------------------------------------------------

          # Monâ€“Thu: once after 5pm
          if [ "$DAY_OF_WEEK" -ge 1 ] && [ "$DAY_OF_WEEK" -le 4 ] && [ "$HOUR" -ge 17 ]; then
            SLOT="weekday_5pm"
          fi

          # Friday slots
          if [ "$DAY_OF_WEEK" = "5" ]; then
            if [ "$HOUR" -ge 12 ]; then SLOT="fri_12"; fi
            if [ "$HOUR" -ge 14 ]; then SLOT="fri_14"; fi
            if [ "$HOUR" -ge 15 ]; then SLOT="fri_15"; fi
            if [ "$HOUR" -ge 16 ]; then SLOT="fri_16"; fi
            if [ "$HOUR" -ge 17 ]; then SLOT="fri_17"; fi
          fi

          # --------------------------------------------------------
          # DECIDE WHETHER TO RUN
          # --------------------------------------------------------
          if [ -n "$SLOT" ]; then
            LAST_RUN=$(jq -r ".runs[\"$SLOT\"] // empty" "$STATE_FILE")

            if [ "$LAST_RUN" != "$TODAY" ]; then
              echo "Slot $SLOT has not run today â€” will run now"
              SHOULD_RUN=true
            else
              echo "Slot $SLOT already ran today â€” skipping"
            fi
          else
            echo "No valid slot yet â€” skipping"
          fi

          # Manual override
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            echo "Manual run detected â€” forcing scrape"
            SHOULD_RUN=true
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "slot=$SLOT" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # RUN SCRAPER
      # ------------------------------------------------------------
      - name: Run scraper
        if: steps.timecheck.outputs.should_run == 'true'
        run: node scripts/scrape_metrics.js

      # ------------------------------------------------------------
      # UPDATE AUTOMATION STATE
      # ------------------------------------------------------------
      - name: Update automation state
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          SLOT="${{ steps.timecheck.outputs.slot }}"
          TODAY=$(TZ=Australia/Sydney date '+%Y-%m-%d')

          jq ".runs[\"$SLOT\"] = \"$TODAY\"" .automation_state.json > tmp.json
          mv tmp.json .automation_state.json

      # ------------------------------------------------------------
      # COMMIT CHANGES
      # ------------------------------------------------------------
      - name: Commit and push changes
        if: steps.timecheck.outputs.should_run == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          git add metrics.json .automation_state.json

          if git diff --cached --quiet; then
            echo "No changes detected; skipping commit"
            exit 0
          fi

          git commit -m "Update Power BI metrics"
          git push

      # ------------------------------------------------------------
      # ALERT ON FAILURE
      # ------------------------------------------------------------
      - name: Alert on failure
        if: failure()
        run: |
          echo "Power BI scrape failed" >&2
